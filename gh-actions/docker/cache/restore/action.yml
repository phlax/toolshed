inputs:
  image-tag:
    type: string
    required: true
  key-suffix:
    type: string
    required: true
  mount-tmpfs:
    type: string
    default: true

runs:
  using: "composite"
  steps:
  - uses: envoyproxy/toolshed/gh-actions/cache/restore@4458dd4bff05f2aa975c407f9ad75fb05077f875
    with:
      key: ${{ inputs.image-tag }}${{ inputs.key-suffix }}
      command: |
        echo "Replacing system docker"
        df -h
        systemctl stop docker docker.socket
        mv /var/lib/docker /var/lib/docker.orig
        sudo rm -rf /var/lib/docker.orig &
        mkdir -p /var/lib/docker
        ls -alh docker.tar.zst
        df -h
        free
        zstd --stdout -d docker.tar.zst | tar -xf - -C /var/lib/docker
        echo "Restored docker"
        systemctl start docker
      mount-tmpfs: ${{ inputs.mount-tmpfs }}
      run-as-sudo: true
